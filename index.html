import express from "express";
import fetch from "node-fetch";

const app = express();
app.use(express.json());

// ===== 環境変数 =====
const CHANNEL_ACCESS_TOKEN = process.env.CHANNEL_ACCESS_TOKEN;
const ADMIN_USER_ID = process.env.ADMIN_USER_ID; // 管理者AのuserId

// ===== Day0メッセージ（確定文面）=====
const DAY0_MESSAGE = {
  type: "text",
  text: `【ようこそ、Vera Sky Harmony へ】
― あなたは「選ばれた」のではありません。「気づいた」のです ―

はじめまして。
そして、ここまで辿り着いてくださり、ありがとうございます。

あなたは今、
売り込みも、説得も、勧誘もされていません。
それにも関わらず、
ここに辿り着いたという事実そのものが、
とても重要な意味を持っています。

────────────────

これからあなたが目にするのは、
・誰かに依存しない
・人に気を遣わない
・無理をしない
・我慢を前提としない

それでいて、
「健康」と「繁栄」が同時に広がっていく仕組みです。

────────────────

Vera Sky Harmony（VSH）は、
従来のMLMの常識をすべて捨てて設計されました。

・人が頑張る → ❌
・人が説明する → ❌
・人が教育する → ❌
・人が拡散する → ❌

これらはすべて、AIが担います。

あなたがすることは、
「理解すること」と「選択すること」だけです。

────────────────

この仕組みは、
✔ 経験
✔ 年齢
✔ 人脈
✔ 話術
いずれも一切問いません。

なぜなら、
人の能力に依存しない設計だからです。

────────────────

ここから数日間、
あなたは「説明」を受けるのではなく、
一つの完成されたシステムを体験していきます。

判断はいつでも自由です。
押されることも、急かされることもありません。

────────────────

ただ一つだけ、大切なことがあります。

「理解してから判断してほしい」

────────────────

それでは、
Vera Sky Harmony の世界へ。

明日は、
「なぜこの仕組みが成り立つのか」をお伝えします。`
};

// ===== Webhook =====
app.post("/webhook", async (req, res) => {
  const event = req.body.events?.[0];
  if (!event) return res.sendStatus(200);

  const userId = event.source?.userId;
  if (!userId) return res.sendStatus(200);

  // 管理者Aは除外
  if (userId === ADMIN_USER_ID) return res.sendStatus(200);

  // follow または 最初の message で Day0送信
  if (event.type === "follow" || event.type === "message") {
    await fetch("https://api.line.me/v2/bot/message/push", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`,
      },
      body: JSON.stringify({
        to: userId,
        messages: [DAY0_MESSAGE],
      }),
    });
  }

  res.sendStatus(200);
});

// ===== 起動 =====
app.listen(process.env.PORT || 10000, () => {
  console.log("VSH Day0 server running");
});
