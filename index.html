import express from "express";
import fetch from "node-fetch";

const app = express();
app.use(express.json());

const CHANNEL_ACCESS_TOKEN = process.env.CHANNEL_ACCESS_TOKEN;
const ADMIN_USER_ID = "ここに管理者のuserId";

const sentUsers = new Set();

const DAY0_MESSAGE = {
  type: "text",
  text: `ようこそ、Vera Sky Harmony へ
― あなたは「選ばれた」のではありません。「気づいた」のです ―

はじめまして。
そして、ここまで辿り着いてくださり、ありがとうございます。

あなたは今、
売り込みも、説得も、勧誘もされていません。
それにも関わらず、
ここに辿り着いたという事実そのものが、
とても重要な意味を持っています。

（以下省略せず全文そのまま入れてください）`
};

app.post("/webhook", async (req, res) => {
  const event = req.body.events[0];
  if (!event) return res.sendStatus(200);

  const userId = event.source?.userId;
  if (!userId) return res.sendStatus(200);

  // 管理者除外
  if (userId === ADMIN_USER_ID) return res.sendStatus(200);

  // 友だち追加のみ
  if (event.type === "follow") {
    if (sentUsers.has(userId)) return res.sendStatus(200);
    sentUsers.add(userId);

    await fetch("https://api.line.me/v2/bot/message/push", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`,
      },
      body: JSON.stringify({
        to: userId,
        messages: [DAY0_MESSAGE],
      }),
    });
  }

  res.sendStatus(200);
});

app.listen(process.env.PORT || 10000);


